{% extends "base.html" %}
{% load static %}

{% block title %}Financial Search & Analysis{% endblock %}

{% block extra_css %}
<style>
    .financial-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .financial-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 32px 24px;
        border-radius: 12px;
        margin-bottom: 32px;
    }

    .financial-header h1 {
        font-size: 28px;
        margin: 0 0 8px 0;
    }

    .financial-header p {
        margin: 0;
        opacity: 0.9;
    }

    .filter-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .filter-control {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 16px;
    }

    .filter-control label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #667eea;
        text-transform: uppercase;
        margin-bottom: 8px;
    }

    .filter-control select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        cursor: pointer;
    }

    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
    }

    .stat-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
    }

    .stat-sublabel {
        font-size: 11px;
        color: #999;
        margin-top: 4px;
    }

    .stat-card.positive .stat-value {
        color: #38ef7d;
    }

    .stat-card.negative .stat-value {
        color: #ef4444;
    }

    .stat-card.warning .stat-value {
        color: #f59e0b;
    }

    .results-table {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 24px;
    }

    .results-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .results-table thead {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .results-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: #667eea;
        border-bottom: 2px solid #667eea;
    }

    .results-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 13px;
    }

    .results-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.05);
    }

    .amount-positive {
        color: #38ef7d;
        font-weight: 600;
    }

    .amount-negative {
        color: #ef4444;
        font-weight: 600;
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 4px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #38ef7d 0%, #667eea 100%);
        border-radius: 3px;
    }

    .filter-type-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
    }

    .filter-type-btn {
        padding: 8px 16px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        color: #666;
        transition: all 0.2s;
    }

    .filter-type-btn.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .filter-type-btn:hover {
        border-color: #667eea;
    }

    @media (max-width: 768px) {
        .filter-controls {
            grid-template-columns: 1fr;
        }

        .statistics-grid {
            grid-template-columns: 1fr;
        }

        .results-table {
            overflow-x: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="financial-container">
        <!-- Header -->
        <div class="financial-header">
            <h1>üí∞ Financial Analysis & Arrears Management</h1>
            <p>Track payments, identify arrears, and analyze collection patterns</p>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-control">
                <label for="yearSelect">Academic Year</label>
                <select id="yearSelect" name="year_id" onchange="updateFilters()">
                    <option value="">All Years</option>
                    {% for year in years %}
                    <option value="{{ year.id }}" {% if year.id|stringformat:"s" == selected_year_id|stringformat:"s" %}selected{% endif %}>
                        {{ year.year }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-control">
                <label for="termSelect">Term</label>
                <select id="termSelect" name="term_id" onchange="updateFilters()">
                    <option value="">All Terms</option>
                    <option value="">Term 1</option>
                    <option value="">Term 2</option>
                    <option value="">Term 3</option>
                </select>
            </div>
        </div>

        <!-- Quick Filter Buttons -->
        <div class="filter-type-buttons">
            <button class="filter-type-btn {% if filter_type == 'all' %}active{% endif %}" 
                    onclick="setFilterType('all')">
                All Students
            </button>
            <button class="filter-type-btn {% if filter_type == 'arrears' %}active{% endif %}" 
                    onclick="setFilterType('arrears')">
                Has Arrears
            </button>
            <button class="filter-type-btn {% if filter_type == 'unpaid' %}active{% endif %}" 
                    onclick="setFilterType('unpaid')">
                Unpaid Fees
            </button>
            <button class="filter-type-btn {% if filter_type == 'collection' %}active{% endif %}" 
                    onclick="setFilterType('collection')">
                Collection Issues
            </button>
        </div>

        <!-- Statistics -->
        <div class="statistics-grid">
            <div class="stat-card positive">
                <div class="stat-label">Total Collected</div>
                <div class="stat-value">${{ statistics.total_collected|floatformat:0 }}</div>
                <div class="stat-sublabel">{{ statistics.students_count }} students</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Total Fee Amount</div>
                <div class="stat-value">${{ statistics.total_fee|floatformat:0 }}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ statistics.collection_rate }}%"></div>
                </div>
                <div class="stat-sublabel">{{ statistics.collection_rate|floatformat:1 }}% collected</div>
            </div>

            <div class="stat-card warning">
                <div class="stat-label">Outstanding Arrears</div>
                <div class="stat-value">${{ statistics.total_arrears|floatformat:0 }}</div>
                <div class="stat-sublabel">Previous balances</div>
            </div>

            <div class="stat-card negative">
                <div class="stat-label">Total Outstanding</div>
                <div class="stat-value">${{ statistics.total_outstanding|floatformat:0 }}</div>
                <div class="stat-sublabel">Current + arrears unpaid</div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="results-table">
            <table>
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>ID</th>
                        <th>Class</th>
                        <th>Term Fee</th>
                        <th>Previous Arrears</th>
                        <th>Amount Paid</th>
                        <th>Currently Owed</th>
                        <th>Collection %</th>
                    </tr>
                </thead>
                <tbody>
                    {% for balance in balances %}
                    <tr>
                        <td>{{ balance.student.name }}</td>
                        <td>{{ balance.student.student_id }}</td>
                        <td>
                            {% if balance.student.student_class %}
                            Grade {{ balance.student.student_class.grade }}, {{ balance.student.student_class.section }}
                            {% else %}
                            ‚Äî
                            {% endif %}
                        </td>
                        <td>${{ balance.term_fee|floatformat:2 }}</td>
                        <td class="amount-negative">${{ balance.previous_arrears|floatformat:2 }}</td>
                        <td class="amount-positive">${{ balance.amount_paid|floatformat:2 }}</td>
                        <td class="amount-negative">${{ balance.current_owed|floatformat:2 }}</td>
                        <td>
                            {% if balance.collection_rate >= 100 %}
                            <span style="color: #38ef7d; font-weight: 600;">100%</span>
                            {% elif balance.collection_rate >= 75 %}
                            <span style="color: #f59e0b; font-weight: 600;">{{ balance.collection_rate|floatformat:1 }}%</span>
                            {% else %}
                            <span style="color: #ef4444; font-weight: 600;">{{ balance.collection_rate|floatformat:1 }}%</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 32px; color: #999;">
                            No financial records found for selected filters
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Export Options -->
        <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
            <button onclick="exportResults()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                üì• Export as CSV
            </button>
            <button onclick="window.print()" style="padding: 10px 20px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 6px; cursor: pointer; font-weight: 600;">
                üñ®Ô∏è Print
            </button>
        </div>
    </div>
</div>

<script>
    function updateFilters() {
        const year = document.getElementById('yearSelect').value;
        const term = document.getElementById('termSelect').value;
        const url = new URL(window.location);
        if (year) url.searchParams.set('year_id', year);
        if (term) url.searchParams.set('term_id', term);
        window.location = url;
    }

    function setFilterType(type) {
        const url = new URL(window.location);
        url.searchParams.set('filter_type', type);
        window.location = url;
    }

    function exportResults() {
        alert('Export feature coming soon!');
    }
</script>
{% endblock %}
