{% extends "base.html" %}
{% load static %}

{% block title %}Statistical Tests - ZIMSEC Analytics{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-900 to-slate-800 text-white">
    {% csrf_token %}
    <!-- Navigation Bar -->
    <nav class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur-lg border-b border-slate-700/50 shadow-xl">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-gradient-to-br from-fuchsia-500 to-purple-600 rounded-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold">Statistical Analysis</h1>
            </div>
            <a href="{% url 'grade7_statistics' %}" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-all font-semibold">
                ← Back to Statistics
            </a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8 space-y-6">
        <!-- Test Selection Panel -->
        <div class="group relative">
            <div class="absolute inset-0 bg-gradient-to-r from-fuchsia-600/20 via-purple-600/20 to-indigo-600/20 rounded-2xl blur-2xl opacity-0 group-hover:opacity-100 transition-all duration-700"></div>
            <div class="relative rounded-2xl p-8 border-2 border-purple-500/60 bg-gradient-to-br from-slate-800/90 via-slate-800/70 to-slate-900/90 backdrop-blur-xl shadow-2xl">
                <h2 class="text-2xl font-bold text-purple-300 mb-6 flex items-center gap-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v10a2 2 0 002 2h5m0 0V6m0 12h5a2 2 0 002-2V8a2 2 0 00-2-2h-5m0 0V6"></path>
                    </svg>
                    Available Statistical Tests
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- T-Test -->
                    <div class="p-4 rounded-lg border-2 border-indigo-500/40 bg-slate-700/50 hover:border-indigo-400 hover:bg-slate-700 transition-all cursor-pointer group/test" onclick="selectTest('ttest')">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <h3 class="font-bold text-indigo-300">T-Test</h3>
                        </div>
                        <p class="text-sm text-slate-300 mb-3">Compare mean aggregates between two groups</p>
                        <div class="text-xs bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded inline-block">
                            2 Groups
                        </div>
                    </div>

                    <!-- ANOVA -->
                    <div class="p-4 rounded-lg border-2 border-violet-500/40 bg-slate-700/50 hover:border-violet-400 hover:bg-slate-700 transition-all cursor-pointer group/test" onclick="selectTest('anova')">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-6 h-6 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <h3 class="font-bold text-violet-300">ANOVA</h3>
                        </div>
                        <p class="text-sm text-slate-300 mb-3">Compare mean aggregates across multiple classes</p>
                        <div class="text-xs bg-violet-500/20 text-violet-300 px-2 py-1 rounded inline-block">
                            3+ Groups
                        </div>
                    </div>

                    <!-- Chi-Square -->
                    <div class="p-4 rounded-lg border-2 border-fuchsia-500/40 bg-slate-700/50 hover:border-fuchsia-400 hover:bg-slate-700 transition-all cursor-pointer group/test" onclick="selectTest('chi_square')">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-6 h-6 text-fuchsia-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                            <h3 class="font-bold text-fuchsia-300">Chi-Square</h3>
                        </div>
                        <p class="text-sm text-slate-300 mb-3">Test independence between categorical variables</p>
                        <div class="text-xs bg-fuchsia-500/20 text-fuchsia-300 px-2 py-1 rounded inline-block">
                            Categories
                        </div>
                    </div>

                    <!-- Correlation -->
                    <div class="p-4 rounded-lg border-2 border-cyan-500/40 bg-slate-700/50 hover:border-cyan-400 hover:bg-slate-700 transition-all cursor-pointer group/test" onclick="selectTest('correlation')">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <h3 class="font-bold text-cyan-300">Correlation</h3>
                        </div>
                        <p class="text-sm text-slate-300 mb-3">Analyze relationships between continuous variables</p>
                        <div class="text-xs bg-cyan-500/20 text-cyan-300 px-2 py-1 rounded inline-block">
                            Relationships
                        </div>
                    </div>
                </div>

                <!-- Year Selection -->
                <div class="mb-6">
                    <label class="block text-slate-300 font-semibold mb-2">Academic Year</label>
                    <select id="testYear" class="w-full px-4 py-3 rounded-lg bg-slate-700/50 border-2 border-slate-600/50 focus:border-purple-500 text-white font-semibold transition-all">
                        <option value="2027" {% if selected_year == 2027 %}selected{% endif %}>2027</option>
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>

                <!-- Group Selection (Conditional) -->
                <div id="groupSelection" class="mb-6 hidden">
                    <label class="block text-slate-300 font-semibold mb-2">Compare by</label>
                    <select id="groupBy" class="w-full px-4 py-3 rounded-lg bg-slate-700/50 border-2 border-slate-600/50 focus:border-purple-500 text-white font-semibold transition-all">
                        <option value="gender">Gender (Male vs Female)</option>
                        <option value="class">Class</option>
                        <option value="subject">Subject</option>
                    </select>
                </div>

                <!-- Run Test Button -->
                <button onclick="runStatisticalTest()" class="w-full px-6 py-4 rounded-lg font-bold text-white bg-gradient-to-r from-fuchsia-500 to-purple-600 hover:shadow-lg hover:shadow-fuchsia-500/50 transition-all hover:scale-105">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Run Selected Test
                </button>
            </div>
        </div>

        <!-- Results Panel -->
        <div id="resultsPanel" class="hidden group relative">
            <div class="absolute inset-0 bg-gradient-to-r from-emerald-600/20 via-teal-600/20 to-cyan-600/20 rounded-2xl blur-2xl opacity-0 group-hover:opacity-100 transition-all duration-700"></div>
            <div class="relative rounded-2xl p-8 border-2 border-emerald-500/60 bg-gradient-to-br from-slate-800/90 via-slate-800/70 to-slate-900/90 backdrop-blur-xl shadow-2xl">
                <h2 class="text-2xl font-bold text-emerald-300 mb-6 flex items-center gap-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Test Results
                </h2>

                <!-- Test Details -->
                <div id="testDetails" class="space-y-6">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Interpretation -->
                <div class="mt-6 p-4 rounded-lg border-l-4 border-emerald-500 bg-emerald-500/10">
                    <h3 class="font-bold text-emerald-300 mb-2 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm2 0h2v2h-2V8z" clip-rule="evenodd"></path>
                        </svg>
                        Interpretation
                    </h3>
                    <p id="interpretation" class="text-slate-300"></p>
                </div>

                <!-- Statistical Guidance -->
                <div class="mt-6 p-4 rounded-lg border-l-4 border-blue-500 bg-blue-500/10">
                    <h3 class="font-bold text-blue-300 mb-2 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zm-5-4a1 1 0 00-1 1v4a1 1 0 102 0V2a1 1 0 00-1-1zM7 8a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                        </svg>
                        Guidance
                    </h3>
                    <p id="guidance" class="text-slate-300"></p>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden text-center py-8">
            <div class="inline-block">
                <div class="w-12 h-12 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
                <p class="text-slate-300 mt-4">Running statistical analysis...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden p-6 rounded-lg bg-red-500/10 border-2 border-red-500/60">
            <h3 class="font-bold text-red-300 mb-2">Error</h3>
            <p id="errorText" class="text-red-200"></p>
        </div>
    </div>
</div>

<script>
let selectedTest = 'ttest';

function selectTest(testName) {
    selectedTest = testName;
    
    // Update visual selection
    document.querySelectorAll('[onclick^="selectTest"]').forEach(el => {
        el.closest('.group\\/test').classList.remove('border-opacity-100', 'bg-opacity-100');
        el.closest('.group\\/test').classList.add('border-opacity-40', 'bg-opacity-50');
    });
    event.currentTarget.classList.remove('border-opacity-40', 'bg-opacity-50');
    event.currentTarget.classList.add('border-opacity-100', 'bg-opacity-100');
    
    // Show/hide group selection based on test type
    const groupSelection = document.getElementById('groupSelection');
    if (['ttest', 'anova', 'chi_square'].includes(testName)) {
        groupSelection.classList.remove('hidden');
    } else {
        groupSelection.classList.add('hidden');
    }
}

function runStatisticalTest() {
    const year = document.getElementById('testYear').value;
    const groupBy = document.getElementById('groupBy').value;
    
    // Show loading
    document.getElementById('loadingIndicator').classList.remove('hidden');
    document.getElementById('resultsPanel').classList.add('hidden');
    document.getElementById('errorMessage').classList.add('hidden');
    
    // Prepare request parameters
    const formData = new FormData();
    formData.append('test_type', selectedTest);
    formData.append('year', year);
    formData.append('group_by', groupBy);
    
    // Fetch results
    fetch(`{% url 'statistical_tests' %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
        .then(async response => {
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `HTTP ${response.status}: Test failed`);
            }
            return data;
        })
        .then(data => {
            displayResults(data);
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('resultsPanel').classList.remove('hidden');
        })
        .catch(error => {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('errorText').textContent = error.message || 'An error occurred';
            console.error('Statistical test error:', error);
        });
}

function displayResults(data) {
    const testDetails = document.getElementById('testDetails');
    testDetails.innerHTML = '';
    
    // Test Information
    const testInfo = document.createElement('div');
    testInfo.className = 'p-4 rounded-lg border-2 border-slate-600/50 bg-slate-700/50';
    testInfo.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <p class="text-slate-400 text-sm">Test Type</p>
                <p class="text-emerald-300 font-bold">${data.test_name}</p>
            </div>
            <div>
                <p class="text-slate-400 text-sm">Test Statistic</p>
                <p class="text-emerald-300 font-bold">${data.test_statistic.toFixed(4)}</p>
            </div>
            <div>
                <p class="text-slate-400 text-sm">P-Value</p>
                <p class="text-emerald-300 font-bold">${data.p_value.toFixed(6)}</p>
            </div>
            <div>
                <p class="text-slate-400 text-sm">Significance</p>
                <p class="font-bold ${data.significant ? 'text-green-400' : 'text-orange-400'}">
                    ${data.significant ? '✓ Significant' : '✗ Not Significant'}
                </p>
            </div>
        </div>
    `;
    testDetails.appendChild(testInfo);
    
    // Group Comparisons if available
    if (data.groups && Object.keys(data.groups).length > 0) {
        const groupTitle = document.createElement('h3');
        groupTitle.className = 'text-xl font-bold text-slate-300 mt-6 mb-4';
        groupTitle.textContent = 'Group Comparisons';
        testDetails.appendChild(groupTitle);
        
        const groupGrid = document.createElement('div');
        groupGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
        
        for (const [groupName, groupStats] of Object.entries(data.groups)) {
            const groupCard = document.createElement('div');
            groupCard.className = 'p-4 rounded-lg border-2 border-slate-600/50 bg-slate-700/50';
            groupCard.innerHTML = `
                <h4 class="font-bold text-slate-300 mb-3">${groupName}</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-400">Students:</span>
                        <span class="text-slate-200">${groupStats.count}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Mean Aggregate:</span>
                        <span class="text-slate-200">${groupStats.mean.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Std Dev:</span>
                        <span class="text-slate-200">${groupStats.std.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Pass Rate:</span>
                        <span class="text-slate-200">${groupStats.pass_rate.toFixed(1)}%</span>
                    </div>
                </div>
            `;
            groupGrid.appendChild(groupCard);
        }
        testDetails.appendChild(groupGrid);
    }
    
    // Effect Size if available
    if (data.effect_size !== undefined) {
        const effectCard = document.createElement('div');
        effectCard.className = 'p-4 rounded-lg border-2 border-violet-500/60 bg-violet-500/10 mt-6';
        const effectInterpretation = 
            data.effect_size < 0.2 ? 'Negligible' :
            data.effect_size < 0.5 ? 'Small' :
            data.effect_size < 0.8 ? 'Medium' :
            'Large';
        effectCard.innerHTML = `
            <h4 class="font-bold text-violet-300 mb-2">Effect Size (Cohen's d)</h4>
            <div class="flex items-center justify-between">
                <span class="text-slate-300">${data.effect_size.toFixed(4)}</span>
                <span class="text-violet-300 font-semibold">${effectInterpretation} Effect</span>
            </div>
        `;
        testDetails.appendChild(effectCard);
    }
    
    // Update interpretation
    document.getElementById('interpretation').textContent = data.interpretation;
    
    // Update guidance
    const guidanceText = data.significant 
        ? 'The differences between groups are statistically significant. Consider investigating the causes and implications for your institution.'
        : 'No statistically significant differences were found between groups. Results may be due to random variation.';
    document.getElementById('guidance').textContent = guidanceText;
}
</script>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    #resultsPanel {
        animation: fadeIn 0.3s ease-out;
    }
</style>
{% endblock %}
