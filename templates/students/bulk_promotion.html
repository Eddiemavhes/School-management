{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Bulk Student Promotion</h1>
        <button id="promoteSelectedBtn" disabled 
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
            Promote Selected Students
        </button>
    </div>

    <!-- Filter Controls -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Grade</label>
                <select id="gradeFilter" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                    <option value="">All Grades</option>
                    {% for grade in grades %}
                    <option value="{{ grade }}">Grade {{ grade }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Section</label>
                <select id="sectionFilter" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                    <option value="">All Sections</option>
                    {% for section in sections %}
                    <option value="{{ section }}">Section {{ section }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Academic Year</label>
                <select id="yearFilter" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                    {% for year in academic_years %}
                    <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Students Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left">
                        <input type="checkbox" id="selectAllCheckbox" class="rounded border-gray-300 text-blue-600">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Class</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Class</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Arrears</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for student in students %}
                <tr>
                    <td class="px-6 py-4">
                        <input type="checkbox" class="student-checkbox rounded border-gray-300 text-blue-600" 
                               data-student-id="{{ student.id }}"
                               {% if student.current_class.grade == 7 %}disabled{% endif %}>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">{{ student.full_name }}</div>
                        <div class="text-sm text-gray-500">ID: {{ student.student_id }}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        Grade {{ student.current_class.grade }}{{ student.current_class.section }}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        {% if student.current_class.grade == 7 %}
                        <span class="text-purple-600 font-semibold">Graduating</span>
                        {% else %}
                        Grade {{ student.current_class.grade|add:"1" }}{{ student.current_class.section }}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm {% if student.total_arrears > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                            ${{ student.total_arrears }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                            {% if student.status == 'ACTIVE' %}bg-green-100 text-green-800
                            {% elif student.status == 'GRADUATED' %}bg-purple-100 text-purple-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ student.get_status_display }}
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                        No students found matching the criteria
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Bulk Promotion</h3>
            <div class="mt-4">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                You are about to promote <span id="selectedStudentCount" class="font-bold">0</span> students.
                                All arrears will be preserved.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="max-h-96 overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">From</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">To</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Arrears</th>
                            </tr>
                        </thead>
                        <tbody id="confirmationTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeConfirmationModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg mr-2">Cancel</button>
                <button onclick="executeBulkPromotion()" class="bg-green-600 text-white px-4 py-2 rounded-lg">Confirm Promotion</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox:not([disabled])');
    const promoteSelectedBtn = document.getElementById('promoteSelectedBtn');
    
    // Handle "Select All" checkbox
    selectAllCheckbox.addEventListener('change', function() {
        studentCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updatePromoteButton();
    });
    
    // Handle individual checkboxes
    studentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllCheckbox();
            updatePromoteButton();
        });
    });
    
    // Handle filter changes
    ['gradeFilter', 'sectionFilter', 'yearFilter'].forEach(filterId => {
        document.getElementById(filterId)?.addEventListener('change', applyFilters);
    });
    
    // Initial button state
    updatePromoteButton();
});

function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox:not([disabled])');
    const checkedBoxes = document.querySelectorAll('.student-checkbox:checked:not([disabled])');
    
    selectAllCheckbox.checked = studentCheckboxes.length > 0 && 
                               studentCheckboxes.length === checkedBoxes.length;
    selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && 
                                    checkedBoxes.length < studentCheckboxes.length;
}

function updatePromoteButton() {
    const checkedBoxes = document.querySelectorAll('.student-checkbox:checked:not([disabled])');
    const promoteSelectedBtn = document.getElementById('promoteSelectedBtn');
    promoteSelectedBtn.disabled = checkedBoxes.length === 0;
}

function showConfirmationModal() {
    const selectedStudents = [];
    document.querySelectorAll('.student-checkbox:checked').forEach(checkbox => {
        const row = checkbox.closest('tr');
        selectedStudents.push({
            id: checkbox.dataset.studentId,
            name: row.querySelector('.text-gray-900').textContent,
            currentClass: row.querySelector('td:nth-child(3)').textContent.trim(),
            newClass: row.querySelector('td:nth-child(4)').textContent.trim(),
            arrears: row.querySelector('td:nth-child(5)').textContent.trim()
        });
    });
    
    // Update confirmation modal content
    document.getElementById('selectedStudentCount').textContent = selectedStudents.length;
    
    const tbody = document.getElementById('confirmationTableBody');
    tbody.innerHTML = '';
    
    selectedStudents.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-4 py-2 text-sm text-gray-900">${student.name}</td>
            <td class="px-4 py-2 text-sm text-gray-500">${student.currentClass}</td>
            <td class="px-4 py-2 text-sm text-gray-500">${student.newClass}</td>
            <td class="px-4 py-2 text-sm text-red-600">${student.arrears}</td>
        `;
        tbody.appendChild(row);
    });
    
    document.getElementById('confirmationModal').classList.remove('hidden');
}

function closeConfirmationModal() {
    document.getElementById('confirmationModal').classList.add('hidden');
}

function executeBulkPromotion() {
    const selectedIds = Array.from(document.querySelectorAll('.student-checkbox:checked'))
                            .map(checkbox => checkbox.dataset.studentId);
    
    fetch('/students/bulk-promote/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            student_ids: selectedIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Failed to promote students');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to promote students');
    });
}

function applyFilters() {
    const grade = document.getElementById('gradeFilter').value;
    const section = document.getElementById('sectionFilter').value;
    const year = document.getElementById('yearFilter').value;
    
    // Reload page with filter parameters
    const url = new URL(window.location.href);
    if (grade) url.searchParams.set('grade', grade);
    if (section) url.searchParams.set('section', section);
    if (year) url.searchParams.set('year', year);
    
    window.location.href = url.toString();
}

// CSRF Token Helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}